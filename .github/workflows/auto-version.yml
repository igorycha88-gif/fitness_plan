name: Auto Version on Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  auto-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Extract current version
      id: version
      run: |
        CURRENT_VERSION=$(grep "versionName" app/build.gradle.kts | grep -oP '(?<=versionName = ")\d+\.\d+')
        CURRENT_CODE=$(grep "versionCode" app/build.gradle.kts | grep -oP '\d+')
        
        MAJOR=$(echo $CURRENT_VERSION | cut -d'.' -f1)
        MINOR=$(echo $CURRENT_VERSION | cut -d'.' -f2)
        
        NEW_MINOR=$((MINOR + 1))
        NEW_VERSION="${MAJOR}.${NEW_MINOR}"
        NEW_CODE=$((CURRENT_CODE + 1))
        
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "current_code=$CURRENT_CODE" >> $GITHUB_OUTPUT
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_code=$NEW_CODE" >> $GITHUB_OUTPUT
        
        echo "Version: $CURRENT_VERSION -> $NEW_VERSION"
        echo "Code: $CURRENT_CODE -> $NEW_CODE"
    
    - name: Update version in build.gradle.kts
      run: |
        sed -i 's/versionCode = ${{ steps.version.outputs.current_code }}/versionCode = ${{ steps.version.outputs.new_code }}/g' app/build.gradle.kts
        sed -i 's/versionName = "${{ steps.version.outputs.current_version }}"/versionName = "${{ steps.version.outputs.new_version }}"/g' app/build.gradle.kts
    
    - name: Commit version bump
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add app/build.gradle.kts
        git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
        git push